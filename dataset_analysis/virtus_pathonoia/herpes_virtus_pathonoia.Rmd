---
title: "herpes_virtus_pathonoia"
author: "Ginna"
date: "2025-08-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggpubr)
library(tidyverse)
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(corrplot)
library(ggcorrplot)
```

```{r reading in virtus data}
library(tidyverse)
numeric_cols <- c("startpos","endpos","numreads","covbases","coverage",
                  "meandepth","meanbaseq","meanmapq","rate_hit")

customized_read_tsv <- function(file) {
  read_tsv(
    file,
    show_col_types = FALSE,
    col_types = cols(.default = col_character())  # <- force everything to char
  ) %>%
    mutate(
      fileName  = basename(file),
      Accession = str_remove(fileName, "_VIRTUS\\.output\\.tsv$")
    ) %>%
    mutate(across(intersect(names(.), numeric_cols), readr::parse_number))  # <- then parse numerics
}

files <- list.files(
  "/Users/ginna/Desktop/internship/practice/virtus2/virtus_herpes_final/",
  full.names = TRUE,
  pattern = "_VIRTUS\\.output\\.tsv$"
)

virtus_herpes_data <- purrr::map_dfr(files, customized_read_tsv) %>%
  select(virus, all_of(numeric_cols), Accession)


```

```{r Read Counts per virus in herpes VIRTUS Data, echo=FALSE}
virtus_herpes_data <- virtus_herpes_data %>%
  mutate(virus = fct_reorder(virus, numreads, .fun=median))

count_data <- virtus_herpes_data %>%
  group_by(virus) %>%
  summarise(n = n())  # just count number of rows per virus

ggplot(virtus_herpes_data, aes(x = virus, y = numreads)) +
  geom_boxplot() +
  coord_flip() +
  geom_text(
  data = count_data,
  aes(x = virus, y = max(virtus_herpes_data$numreads, na.rm = TRUE) * 1.05, label = paste("n =", n)),
  inherit.aes = FALSE,
  size = 2.5,
  hjust = -0.1) +
  labs(title = "Read Counts per virus in herpes VIRTUS Data",
      x = "virus",
      y = "Number of Reads") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

```{r reading in pathonoia data}
# Load the data
df_herpes <- read_csv("~/Desktop/internship/practice/virtus2/herpes_pathonoia_contamination.csv")

# Convert to long format
df_long_herpes <- df_herpes %>%
  pivot_longer(
    cols = -c(species_name, phylo_level, parent),
    names_to = "sample_name",
    values_to = "value"
  )


```


```{r}
read_threshold <- 10000

df_long_herpes <- df_long_herpes %>%
  filter(value >= read_threshold) %>%
  group_by(species_name) %>%
  filter(n_distinct(sample_name) > 1) %>%
  ungroup() %>%
  mutate(species_name = fct_reorder(species_name, value, .fun = median, .desc = TRUE))

# 2) Recompute count_data from the same filtered df_long_herpes
count_data <- df_long_herpes %>%
  group_by(species_name) %>%
  summarise(n = n_distinct(sample_name), .groups = "drop")

# 3) Plot (labels always match the data shown)
y_top <- max(df_long_herpes$value, na.rm = TRUE) * 1.05

ggplot(df_long_herpes, aes(x = species_name, y = value)) +
  geom_boxplot(outlier.size = 0.5) +
  coord_flip() +
  geom_text(
    data = count_data,
    aes(x = species_name, y = y_top, label = paste("n =", n)),
    inherit.aes = FALSE, size = 2.5, hjust = -0.1
  ) +
  labs(
    title = "Read Counts per species_name in herpes Pathonoia Data",
    x = "species_name (species_name)", y = "Read Count"
  ) +
  theme_minimal(base_size = 8) +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

